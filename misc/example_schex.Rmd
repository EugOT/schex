---
title: "Example for using schex"
author: "Saskia Freytag"
date: "02/07/2019"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(TENxPBMCData)
library(scater)
library(scran)
library(ggplot2)
library(schex)
library(cowplot)
```

## Setup single cell data

```{r load}
tenx_pbmc6k <- TENxPBMCData(dataset = "pbmc6k")
```

### Filtering

I filter cells with high mitochondrial content as well as cells with low
library size or feature count.

```{r filter-cells}
rowData(tenx_pbmc6k)$Mito <- grepl("^MT-", rowData(tenx_pbmc6k)$Symbol_TENx)
colData(tenx_pbmc6k) <- cbind(colData(tenx_pbmc6k), 
        perCellQCMetrics(tenx_pbmc6k, 
        subsets=list(Mt=rowData(tenx_pbmc6k)$Mito)))
rowData(tenx_pbmc6k) <- cbind(rowData(tenx_pbmc6k), 
        perFeatureQCMetrics(tenx_pbmc6k))

tenx_pbmc6k <- tenx_pbmc3k[, !colData(tenx_pbmc6k)$subsets_Mt_percent > 50]

libsize_drop <- isOutlier(tenx_pbmc6k$total,
  nmads = 3,type = "lower", log = TRUE
)
feature_drop <- isOutlier(tenx_pbmc6k$detected,
  nmads = 3, type = "lower", log = TRUE
)
tenx_pbmc6k <- tenx_pbmc6k[, !(libsize_drop | feature_drop)]
```

I filter any genes that have 0 count for all cells.

```{r filter-genes}
rm_ind <- calculateAverage(tenx_pbmc6k)<0
tenx_pbmc6k <- tenx_pbmc6k[!rm_ind,]
```

### Normalization

I normalize the data by using a simple library size normalization feature.

```{r norm, message=FALSE, warning=FALSE}
tenx_pbmc6k <- scater::normalize(tenx_pbmc6k)
```

### Dimension reduction

I use both Principal Components Analysis (PCA) and Uniform Manifold 
Approximation and Projection (UMAP) in order to obtain reduced dimension 
representations of the data.

```{r dim-red, message=FALSE, warning=FALSE}
tenx_pbmc6k <- runPCA(tenx_pbmc6k)
tenx_pbmc6k <- runUMAP(tenx_pbmc6k, use_dimred = "PCA", n_neighbors = 50,
                       spread = 1, 
                       min_dist = 0.4)
```

## Plotting

```{r ggplot-random, dev = "png"}
gene <- "CD19"
gene_id <- match(gene, rowData(tenx_pbmc6k)$Symbol_TENx)
dat <- data.frame(umap1 = reducedDim(tenx_pbmc6k, "UMAP")[,1],
                  umap2 = reducedDim(tenx_pbmc6k, "UMAP")[,2],
                  gene = counts(tenx_pbmc6k[gene_id,]))

ggplot(dat, aes(x=umap1, y=umap2, colour=gene)) + geom_point(alpha=0.5) +
  theme_classic() + scale_color_viridis_c(name=gene)+ 
  ggtitle(paste0("Expression of ", gene))
```

```{r ggplot-increasing, dev = "png"}
dat <- dat[order(dat$gene, decreasing = FALSE),]

g1 <- ggplot(dat, aes(x=umap1, y=umap2, colour=gene)) + geom_point(alpha=0.5) +
  theme_classic() + scale_color_viridis_c(name=gene) 

ggsave(g1, file=here::here("misc/increasing.pdf"), width=4, height=3)

g1
```

```{r ggplot-decreasing, dev = "png"}
dat <- dat[order(dat$gene, decreasing = TRUE),]

g2 <- ggplot(dat, aes(x=umap1, y=umap2, colour=gene)) + geom_point(alpha=0.5) +
  theme_classic() + scale_color_viridis_c(name=gene)

ggsave(g2, file=here::here("misc/decreasing.pdf"), width=4, height=3)

g2
```

```{r schex, dev = "png"}
tenx_pbmc6k <- make_hexbin(tenx_pbmc6k, nbins = 40, 
                           dimension_reduction = "UMAP")
gene_id_id <-rownames(tenx_pbmc6k)[gene_id]
g3 <- plot_hexbin_gene(tenx_pbmc6k, type="logcounts", gene=gene_id_id, 
                 action="mean", xlab="umap1", ylab="umap2", 
                 title=paste0(""))

ggsave(g3, file=here::here("misc/hexbin.pdf"), width=4, height=3)

g3
```


## Combine all plots for publication

```{r}
gg <- ggdraw() +
  draw_plot(g1, x = 0, y = .55, width = .5, height = .45) +
  draw_plot(g2, x = .5, y = .55, width = .5, height = .45) +
  draw_plot(g3, x = 0, y = 0, width = 0.6, height = 0.55) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(0, 0.5, 0), y = c(1, 1, 0.55))

ggsave(gg, file="Figure_1.png")
```
